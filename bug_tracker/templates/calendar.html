<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - Bug Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .calendar-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(232, 244, 248, 0.95) 0%, rgba(207, 239, 252, 0.95) 100%);
            border-radius: 10px;
            border: 1px solid rgba(0, 180, 216, 0.3);
            box-shadow: 0 4px 12px rgba(0, 119, 182, 0.12);
        }
        
        .week-display {
            font-size: 1.1em;
            font-weight: 600;
            color: #003d5c;
            min-width: 250px;
            text-align: center;
        }
        
        .nav-button {
            background: linear-gradient(135deg, #0077b6 0%, #005f73 100%);
            color: #ffffff;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 119, 182, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-button:hover {
            background: linear-gradient(135deg, #00b4d8 0%, #0096c7 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 180, 216, 0.4);
        }
        
        .nav-button:active {
            transform: translateY(0);
        }
        
        .today-button {
            background: linear-gradient(135deg, #48cae4 0%, #00b4d8 100%);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            font-weight: 600;
            color: #003d5c;
            box-shadow: 0 4px 15px rgba(72, 202, 228, 0.3);
        }
        
        .today-button:hover {
            background: linear-gradient(135deg, #90e0ef 0%, #48cae4 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 202, 228, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Bug Tracker</h1>
            <nav>
                <a href="/">Home</a>
                <a href="/issue/new">Issues</a>
                <a href="/users/new">Assignees</a>
                <a href="/calendar">Calendar</a>
                <a href="/chat">Chatbot</a>
            </nav>
        </header>
        
        <main>
            <section class="calendar-section">
                <h2>Weekly Calendar</h2>
                
                <div class="calendar-navigation">
                    <button class="nav-button" id="prev-week" onclick="changeWeek(-1)">
                        <span>◀</span> Previous Week
                    </button>
                    <div class="week-display" id="week-range"></div>
                    <button class="nav-button" id="next-week" onclick="changeWeek(1)">
                        Next Week <span>▶</span>
                    </button>
                    <button class="today-button" onclick="goToToday()">Today</button>
                </div>
                
                <div id="week-header"></div>
                <div id="calendar-grid" class="calendar-grid">
                    <!-- Calendar columns will be generated by JavaScript -->
                </div>
            </section>
        </main>
    </div>
    
    <script>
        let currentWeekOffset = 0; // 0 = current week, -1 = previous week, 1 = next week
        
        // Get week dates based on offset (Monday to Sunday)
        function getWeek(offset = 0) {
            const today = new Date();
            today.setDate(today.getDate() + (offset * 7)); // Add/subtract weeks
            
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
            const monday = new Date(today.setDate(diff));
            
            const week = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                week.push(date);
            }
            return week;
        }
        
        // Get day name (Mon, Tue, etc.)
        function getDayName(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return days[date.getDay()];
        }
        
        // Format date as YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Format date for display (e.g., "Jan 15")
        function formatDisplayDate(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getDate()}`;
        }
        
        // Check if two dates are on the same day
        function isSameDay(date1, date2) {
            return formatDate(date1) === formatDate(date2);
        }
        
        // Get status color class
        function getStatusColor(status) {
            const statusLower = status.toLowerCase().replace('-', '');
            if (statusLower === 'open') {
                return 'status-open';
            } else if (statusLower === 'inprogress') {
                return 'status-inprogress';
            } else if (statusLower === 'closed') {
                return 'status-closed';
            }
            return 'status-default';
        }
        
        // Update week range display
        function updateWeekRange(week) {
            const weekRangeEl = document.getElementById('week-range');
            const startDate = formatDisplayDate(week[0]);
            const endDate = formatDisplayDate(week[6]);
            const year = week[0].getFullYear();
            weekRangeEl.textContent = `${startDate} - ${endDate}, ${year}`;
        }
        
        // Change week (offset: -1 for previous, 1 for next)
        function changeWeek(offset) {
            currentWeekOffset += offset;
            loadCalendar();
        }
        
        // Go back to current week
        function goToToday() {
            currentWeekOffset = 0;
            loadCalendar();
        }
        
        // Fetch and display issues in calendar view
        async function loadCalendar() {
            try {
                const response = await fetch('/issues');
                const issues = await response.json();
                const calendarGrid = document.getElementById('calendar-grid');
                const weekHeader = document.getElementById('week-header');
                
                // Get week based on current offset
                const week = getWeek(currentWeekOffset);
                
                // Update week range display
                updateWeekRange(week);
                
                // Create week header
                weekHeader.innerHTML = '<div class="calendar-week-header">' +
                    week.map(date => `
                        <div class="calendar-day-header">
                            <div class="day-name">${getDayName(date)}</div>
                            <div class="day-date">${date.getDate()}/${date.getMonth() + 1}</div>
                        </div>
                    `).join('') +
                    '</div>';
                
                // Filter issues with due dates
                const issuesWithDates = issues.filter(issue => issue.due_date);
                
                // Organize issues by day
                const issuesByDay = {};
                week.forEach(date => {
                    issuesByDay[formatDate(date)] = [];
                });
                
                issuesWithDates.forEach(issue => {
                    const dueDate = new Date(issue.due_date);
                    const dateKey = formatDate(dueDate);
                    
                    // Check if the issue's due date falls within the current week
                    week.forEach(weekDate => {
                        if (isSameDay(dueDate, weekDate)) {
                            if (!issuesByDay[dateKey]) {
                                issuesByDay[dateKey] = [];
                            }
                            issuesByDay[dateKey].push(issue);
                        }
                    });
                });
                
                // Create calendar grid
                calendarGrid.innerHTML = week.map(date => {
                    const dateKey = formatDate(date);
                    const dayIssues = issuesByDay[dateKey] || [];
                    
                    return `
                        <div class="calendar-day-column">
                            ${dayIssues.map(issue => `
                                <div class="calendar-issue-item ${getStatusColor(issue.status)}" title="${issue.description}">
                                    <div class="issue-title">${issue.title}</div>
                                    <div class="issue-meta-small">
                                        <span class="status-badge ${getStatusColor(issue.status)}">${issue.status}</span>
                                        ${issue.priority ? `<span class="priority-badge priority-${issue.priority.toLowerCase()}">${issue.priority}</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                            ${dayIssues.length === 0 ? '<div class="calendar-empty">No issues</div>' : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading calendar:', error);
                document.getElementById('calendar-grid').innerHTML = '<p class="error">Error loading calendar.</p>';
            }
        }
        
        // Initial load
        loadCalendar();
    </script>
</body>
</html>